name: DevSecOps Self-Hosted Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  # === JOB 1: SECURITY CHECKS (Jalan di Cloud GitHub biar hemat resource VM) ===
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. SECRET SCANNING (TruffleHog)
      - name: TruffleHog Secret Scan
        run: |
          docker run --rm -v "${{ github.workspace }}:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd --only-verified --fail

      # 2. GO SECURITY SCAN (Gosec - Manual Install)
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Gosec & Run Scan
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          cd backend
          go mod tidy
          go mod download
          $(go env GOPATH)/bin/gosec -no-fail -fmt table ./...

      # 3. VULNERABILITY SCAN (Trivy - Filesystem)
      # Cek apakah ada library usang/berbahaya di package.json atau go.mod
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'table'
          exit-code: '0' # Warning dulu, jangan gagalkan build (ganti 1 kalau mau strict)
          severity: 'CRITICAL,HIGH'

  # === JOB 2: DEPLOY LANGSUNG DI VM (Self-Hosted) ===
  deploy-local:
    needs: security-check  # Tunggu security lolos dulu
    runs-on: self-hosted   # <--- INI KUNCINYA (Jalan di VM kamu sendiri)
    
    steps:
      # 1. Runner download kodingan terbaru dari GitHub ke folder runner
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Pindahkan file dari folder Runner ke folder Aplikasi (~/myapp)
      # Kita pakai rsync biar rapi (hanya update yang berubah)
      - name: Sync Files to App Directory
        run: |
          # Buat folder tujuan kalau belum ada
          mkdir -p ~/myapp
          
          # Copy semua file dari workspace runner saat ini ke ~/myapp
          # exclude .git biar ringan
          rsync -av --progress . ~/myapp --exclude .git
          
          # Fix permission (takutnya runner user beda sama docker user)
          chmod +x ~/myapp/backend/main.go 2>/dev/null || true

      # 3. Build & Restart Docker (Langsung perintah lokal)
      - name: Rebuild & Restart Docker
        run: |
          cd ~/myapp
          
          echo "ðŸš€ Memulai Deployment Lokal..."
          
          # Matikan container lama
          docker compose stop backend frontend || true
          docker compose rm -f backend frontend || true
          
          # Build ulang (menggunakan cache lokal VM, jadi lebih cepat)
          docker compose up -d --build backend frontend
          
          # Bersihkan sampah
          docker image prune -f
          
          echo "âœ… Deployment Selesai!"