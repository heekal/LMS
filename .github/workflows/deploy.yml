name: DevSecOps Self-Hosted Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  # === JOB 1: SECURITY CHECKS (Di VM Self-Hosted) ===
  security-check:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. SECRET SCANNING (TruffleHog)
      - name: TruffleHog Secret Scan
        run: |
          docker run --rm -v "${{ github.workspace }}:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd --only-verified --fail

      # 2. GO SECURITY SCAN (Gosec)
      - name: Install Gosec & Run Scan
        run: |
          # Cek apakah gosec sudah terinstall
          if ! command -v gosec &> /dev/null; then
            go install github.com/securego/gosec/v2/cmd/gosec@latest
          fi
          
          cd backend
          go mod tidy
          go mod download
          $(go env GOPATH)/bin/gosec -no-fail -fmt table ./...

      # 3. VULNERABILITY SCAN (Trivy - Filesystem)
      - name: Trivy FS Scan
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/scan \
            aquasecurity/trivy:latest \
            fs /scan \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --format table

  # === JOB 2: DEPLOY & DAST SCAN (Self-Hosted) ===
  deploy-and-scan:
    needs: security-check
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sync Files to App Directory
        run: |
          mkdir -p ~/myapp/zap
          rsync -av --progress . ~/myapp --exclude .git

      - name: Rebuild & Restart Docker
        run: |
          cd ~/myapp
          echo "üöÄ Memulai Deployment Lokal..."
          
          # Stop & remove old containers
          docker compose stop backend frontend || true
          docker compose rm -f backend frontend || true
          
          # Build & start new containers
          docker compose up -d --build backend frontend
          
          # Cleanup unused images
          docker image prune -f
          
          echo "‚è≥ Menunggu backend siap..."
          sleep 15
          
          # Health check
          curl -f http://localhost:8080/api/health || echo "Backend belum siap"

      # ZAP BASELINE SCAN
      - name: ZAP Baseline Scan
        run: |
          cd ~/myapp
          
          # Pastikan folder zap ada
          mkdir -p zap
          
          # Run ZAP scan
          docker run --rm \
            --network myapp_default \
            -v $(pwd)/zap:/zap/wrk \
            zaproxy/zap-stable \
            zap-baseline.py \
            -t http://backend:8080/api/health \
            -r baseline-report.html \
            -I || true
          
          echo "üìä ZAP Scan selesai!"
          ls -lh zap/baseline-report.html

      # Optional: Upload report ke GitHub (butuh git push atau artifact)
      - name: Archive ZAP Report
        if: always()
        run: |
          cd ~/myapp/zap
          if [ -f baseline-report.html ]; then
            cp baseline-report.html baseline-report-$(date +%Y%m%d-%H%M%S).html
            echo "‚úÖ Report disimpan di ~/myapp/zap/"
          fi

      - name: Show Deployment Status
        run: |
          echo "================================"
          echo "üéâ DEPLOYMENT COMPLETE"
          echo "================================"
          docker ps --filter "name=myapp"
          echo ""
          echo "üìä ZAP Report: ~/myapp/zap/baseline-report.html"
          echo "üåê Frontend: http://localhost:3001"
          echo "üîß Backend: http://localhost:8080"