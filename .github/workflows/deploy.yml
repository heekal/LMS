name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # === JOB 1: SECURITY CHECKS (SAST & SECRETS) ===
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Penting untuk SonarQube agar bisa baca history git

      # 1. SECRET SCANNING (Mencegah kebocoran password)
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

      # 2. SONARQUBE / SONARCLOUD SCAN (Code Quality)
      # Pastikan sudah daftar di SonarCloud.io dan set SONAR_TOKEN
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Bawaan GitHub (gak perlu setting)
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Wajib setting di Secrets
        with:
          args: >
            -Dsonar.organization=kal
            -Dsonar.projectKey=heekal_LMS
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*_test.go,**/vendor/**,frontend/node_modules/**,frontend/dist/**

      # 3. GO SECURITY SCAN (Khusus Backend)
      - name: Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./backend/...

  # === JOB 2: BUILD, SCAN IMAGE, & DEPLOY ===
  build-and-deploy:
    needs: security-check  # Hanya jalan kalau security check LOLOS (Hijau)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- BACKEND PROCESS ---
      - name: Build Backend Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp-backend:latest ./backend

      # 4. TRIVY IMAGE SCANNING (Backend)
      # Cek apakah OS container (Alpine/Debian) punya celah keamanan
      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/myapp-backend:latest'
          format: 'table'
          exit-code: '1'        # GAGALKAN pipeline jika ada vulnerability CRITICAL
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Push Backend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/myapp-backend:latest

      # --- FRONTEND PROCESS ---
      - name: Build Frontend Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp-frontend:latest ./frontend

      # 5. TRIVY IMAGE SCANNING (Frontend)
      - name: Run Trivy vulnerability scanner (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/myapp-frontend:latest'
          format: 'table'
          exit-code: '0'        # Warning aja, jangan gagalkan (opsional)
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Push Frontend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/myapp-frontend:latest

      # --- DEPLOYMENT ---
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            cd ~/myapp
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            
            # Pull image baru dulu sebelum matikan container lama (Zero Downtime attempt)
            docker compose pull backend frontend
            
            docker compose stop backend frontend
            docker compose rm -f backend frontend
            docker compose up -d
            docker image prune -f