name: Deploy Direct to VM

on:
  push:
    branches: [ "main" ]

jobs:
  # === JOB 1: SECURITY CHECKS (Tetap kita pakai biar aman) ===
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. SECRET SCANNING
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --debug --only-verified --filesystem .

      # 2. GO SECURITY SCAN (Manual Install biar stabil)
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Gosec & Run Scan
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          cd backend
          go mod tidy
          go mod download
          $(go env GOPATH)/bin/gosec -no-fail -fmt table ./...

  # === JOB 2: COPY CODE & BUILD ON SERVER ===
  deploy-to-vm:
    needs: security-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. COPY SEMUA KODINGAN KE SERVER
      # Ini akan menimpa folder backend/ dan frontend/ di server dengan yang terbaru dari GitHub
      - name: Copy Files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          source: "."  # Copy semua file di repo ini
          target: "~/myapp" # Ke folder myapp di server
          # Kita exclude file yang gak perlu dikirim biar cepet
          rm: false # Jangan hapus file lain yang ada di server (misal .env)

      # 2. MASUK KE SERVER & SURUH DOCKER BUILD ULANG
      - name: SSH & Rebuild Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            cd ~/myapp
            
            # Matikan container aplikasi (Loki dkk biarkan nyala kalau mau)
            docker compose stop backend frontend
            
            # Hapus container lama
            docker compose rm -f backend frontend
            
            # BUILD ULANG (Ini kuncinya, dia bakal build pakai CPU server lu)
            # --build artinya: "Paksa build ulang walaupun image sudah ada"
            docker compose up -d --build backend frontend
            
            # Bersihkan image sampah (dangling images) bekas build sebelumnya
            docker image prune -f